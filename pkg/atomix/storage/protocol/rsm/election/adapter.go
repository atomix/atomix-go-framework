// Code generated by atomix-go-framework. DO NOT EDIT.
package election

import (
	"github.com/atomix/atomix-go-framework/pkg/atomix/errors"
	"github.com/atomix/atomix-go-framework/pkg/atomix/logging"
	"github.com/atomix/atomix-go-framework/pkg/atomix/storage/protocol/rsm"
	"io"
)

var log = logging.GetLogger("atomix", "election", "service")

const Type = "Election"

const (
	enterOp    = "Enter"
	withdrawOp = "Withdraw"
	anointOp   = "Anoint"
	promoteOp  = "Promote"
	evictOp    = "Evict"
	getTermOp  = "GetTerm"
	eventsOp   = "Events"
)

var newServiceFunc rsm.NewServiceFunc

func registerServiceFunc(rsmf NewServiceFunc) {
	newServiceFunc = func(context rsm.ServiceContext) rsm.Service {
		return &ServiceAdaptor{
			ServiceContext: context,
			rsm:            rsmf(newServiceContext(context)),
		}
	}
}

type NewServiceFunc func(ServiceContext) Service

// RegisterService registers the election primitive service on the given node
func RegisterService(node *rsm.Node) {
	node.RegisterService(Type, newServiceFunc)
}

type ServiceAdaptor struct {
	rsm.ServiceContext
	rsm Service
}

func (s *ServiceAdaptor) ExecuteCommand(command rsm.Command) error {
	switch command.OperationID() {
	case 1:
		p := newEnterProposal(command)
		log.Debugf("Proposing EnterProposal %s", p)
		err := s.rsm.Enter(p)
		if err != nil {
			log.Warn(err)
			return err
		}
		return nil
	case 2:
		p := newWithdrawProposal(command)
		log.Debugf("Proposing WithdrawProposal %s", p)
		err := s.rsm.Withdraw(p)
		if err != nil {
			log.Warn(err)
			return err
		}
		return nil
	case 3:
		p := newAnointProposal(command)
		log.Debugf("Proposing AnointProposal %s", p)
		err := s.rsm.Anoint(p)
		if err != nil {
			log.Warn(err)
			return err
		}
		return nil
	case 4:
		p := newPromoteProposal(command)
		log.Debugf("Proposing PromoteProposal %s", p)
		err := s.rsm.Promote(p)
		if err != nil {
			log.Warn(err)
			return err
		}
		return nil
	case 5:
		p := newEvictProposal(command)
		log.Debugf("Proposing EvictProposal %s", p)
		err := s.rsm.Evict(p)
		if err != nil {
			log.Warn(err)
			return err
		}
		return nil
	case 7:
		p := newEventsProposal(command)
		log.Debugf("Proposing EventsProposal %s", p)
		err := s.rsm.Events(p)
		if err != nil {
			log.Warn(err)
			return err
		}
		return nil
	default:
		err := errors.NewNotSupported("unknown operation %d", command.OperationID())
		log.Warn(err)
		return err
	}
}

func (s *ServiceAdaptor) ExecuteQuery(query rsm.Query) error {
	switch query.OperationID() {
	case 6:
		q := newGetTermQuery(query)
		log.Debugf("Querying GetTermQuery %s", q)
		err := s.rsm.GetTerm(q)
		if err != nil {
			log.Warn(err)
			return err
		}
		return nil
	default:
		err := errors.NewNotSupported("unknown operation %d", query.OperationID())
		log.Warn(err)
		return err
	}
}
func (s *ServiceAdaptor) Backup(writer io.Writer) error {
	err := s.rsm.Backup(newSnapshotWriter(writer))
	if err != nil {
		log.Error(err)
		return err
	}
	return nil
}

func (s *ServiceAdaptor) Restore(reader io.Reader) error {
	err := s.rsm.Restore(newSnapshotReader(reader))
	if err != nil {
		log.Error(err)
		return err
	}
	return nil
}

var _ rsm.Service = &ServiceAdaptor{}
